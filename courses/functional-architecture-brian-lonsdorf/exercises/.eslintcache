[{"/Users/jean/prj/flex/user-payments/tools/debit/src/index.ts":"1"},{"size":3815,"mtime":1623077481098,"results":"2","hashOfConfig":"3"},{"filePath":"4","messages":"5","errorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"6"},"1gt1nxl","/Users/jean/prj/flex/user-payments/tools/debit/src/index.ts",["7"],"import { promises as fs } from \"fs\";\nimport Stripe from \"stripe\";\nimport serverlessMysql from \"serverless-mysql\";\nimport { options as yargsOptions } from \"yargs\";\n\nimport * as idempotent from \"@flexapp/idempotent\";\nimport { Result } from \"@flexapp/result\";\nimport {\n  Dispatcher,\n  EntityID,\n  FlexEvent,\n  PublishedEvent,\n  Publisher,\n  Version,\n} from \"@flexapp/events-core\";\nimport { log, configure } from \"@flexapp/logger\";\nimport { DynamoEventStore } from \"@flexapp/events-store-dynamo\";\nimport { StripeCharge } from \"@flexapp/user-payment-commands\";\nimport { MySQLStore } from \"@flexapp/mysql-store\";\nimport { UserPayment } from \"@flexapp/user-payment-types\";\n\nconfigure({ level: \"debug\" });\n\nconst read = async (file: string): Promise<UserPayment> => {\n  const buffer = await fs.readFile(file);\n  return JSON.parse(buffer.toString(\"utf8\"));\n};\n\nconst publisher =\n  (publish: Publisher): Dispatcher.Publisher =>\n  async (\n    entity: EntityID,\n    event: FlexEvent\n  ): Promise<Result<PublishedEvent>> => {\n    const pevent = await publish(entity, event, {});\n\n    if (pevent === \"version-conflict\") {\n      return Result.failure(\"Version conflict\");\n    }\n\n    return Result.success(pevent);\n  };\n\nexport async function main() {\n  const logger = () => log.with({ origin: \"tools-debit\" });\n\n  const { argv } = yargsOptions({\n    dryRun: {\n      alias: \"dry-run\",\n      type: \"boolean\",\n      default: true,\n    },\n    apiKey: {\n      alias: \"api-key\",\n      string: true,\n      demandOption: true,\n    },\n    eventsTable: {\n      alias: \"events-table\",\n      string: true,\n      demandOption: true,\n    },\n    dbHost: {\n      alias: \"database-host\",\n      string: true,\n      demandOption: true,\n    },\n    dbName: {\n      alias: \"database-name\",\n      string: true,\n      demandOption: true,\n    },\n    dbUsername: {\n      alias: \"database-username\",\n      string: true,\n      demandOption: true,\n    },\n    dbPassword: {\n      alias: \"db-password\",\n      string: true,\n      demandOption: true,\n    },\n    scheduledCharge: {\n      alias: \"scheduled-charge\",\n      string: true,\n      demandOption: true,\n    },\n    customer: {\n      alias: \"customer\",\n      string: true,\n      demandOption: true,\n    },\n    state: {\n      alias: \"state\",\n      string: true,\n      demandOption: true,\n    },\n  });\n\n  const {\n    dryRun,\n    apiKey,\n    eventsTable,\n    dbHost,\n    dbName,\n    dbUsername,\n    dbPassword,\n    customer,\n    scheduledCharge,\n    state: _state,\n  } = argv;\n\n  const { publish } = DynamoEventStore.create(eventsTable);\n  const mysql = serverlessMysql({\n    config: {\n      host: dbHost,\n      database: dbName,\n      user: dbUsername,\n      password: dbPassword,\n    },\n  });\n  const stripe = new Stripe(apiKey, { apiVersion: \"2020-08-27\" });\n\n  const config = {\n    logger,\n    stripe,\n    store: () => MySQLStore.create({ logger, mysql: () => mysql }),\n    idempotentStore: () => idempotent.DynamoStore.create(eventsTable),\n  };\n\n  const command: StripeCharge = {\n    type: StripeCharge.command,\n    target: { id: customer, type: \"customer\" },\n    payload: {\n      scheduledChargeId: `prisma:${scheduledCharge}`,\n    },\n  };\n\n  const print = async (\n    state: UserPayment,\n    version: Version,\n    _command: StripeCharge,\n    _publisher: Dispatcher.Publisher,\n    _options: Dispatcher.ExecuteOptions = {}\n  ) => {\n    console.log({\n      state,\n      version,\n      message: \"DRY RUN\",\n    });\n    return Result.success(true);\n  };\n\n  const state = await read(_state);\n\n  const process = dryRun ? print : StripeCharge.handler(config);\n\n  const result = await process(\n    state,\n    \"unknown\",\n    command,\n    publisher(publish),\n    {}\n  );\n\n  result.on(\n    () => console.log({ command, message: \"successfully processed command\" }),\n    (e) => {\n      console.log({ e });\n    }\n  );\n}\n",{"ruleId":"8","severity":1,"message":"9","line":44,"column":8,"nodeType":"10","messageId":"11","endLine":44,"endColumn":29},"@typescript-eslint/explicit-module-boundary-types","Missing return type on function.","FunctionDeclaration","missingReturnType"]